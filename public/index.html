<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crystal Med</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #000;
            color: #fff;
        }
        #map {
            height: 100vh;
            width: 100vw;
        }
        .header {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            color: #00ff00; /* Green theme */
        }
        .filters-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .join-btn {
            position: absolute;
            top: 60px;
            left: 10px;
            z-index: 1000;
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #111;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #00ff00;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        .profile-info {
            text-align: center;
        }
        .profile-info img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid #00ff00;
        }
        .chat-messages {
            height: 200px;
            overflow-y: scroll;
            background: #222;
            padding: 10px;
            margin-bottom: 10px;
        }
        .chat-input {
            width: 100%;
            padding: 10px;
            background: #333;
            color: #fff;
            border: none;
        }
        .filter-options, .join-options {
            display: flex;
            flex-direction: column;
        }
        .filter-options label, .join-options label {
            margin: 5px 0;
        }
        .leaflet-tooltip {
            background-color: rgba(0,0,0,0.7);
            color: white;
            border: none;
            padding: 2px 5px;
            font-size: 12px;
            white-space: nowrap;
            text-align: center;
            transform: translateX(-50%);
        }
        #notification {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.8);
            color: black;
            padding: 10px;
            border-radius: 5px;
            z-index: 1002;
            cursor: pointer;
            display: none;
        }
        #chat-buttons {
            position: absolute;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            display: flex;
            flex-wrap: wrap;
        }
        .chat-button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
            border-radius: 5px;
        }
        #show-location-btn {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 10px;
        }
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            font-size: 20px;
            color: #00ff00;
        }
        @media (max-width: 768px) {
            .leaflet-tooltip {
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="loading-message">Map is loading...</div>
    <div id="map"></div>
    <div class="header">
        <h1>Crystal Med</h1>
    </div>
    <button class="filters-btn" onclick="openModal('filtersModal')">Filters</button>
    <button class="join-btn" onclick="joinMap()">Appear on Map</button>
    <button id="end-session-btn" style="position: absolute; top: 60px; left: 150px; z-index: 1000; background: red; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; display: none;" onclick="openEndSessionModal()">End Session</button>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('profileModal')">&times;</span>
            <div class="profile-info">
                <img id="profileImg" src="https://ineedmeth.com/wp-content/uploads/2025/07/logo.png" alt="Profile">
                <h2 id="profileName"></h2>
                <p id="profileType"></p>
                <p id="profileDetails"></p>
                <button onclick="openChat()">Chat</button>
            </div>
        </div>
    </div>

    <!-- Chat Modal -->
    <div id="chatModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('chatModal')">&times;</span>
            <h2>Chat with <span id="chatName"></span></h2>
            <div class="chat-messages" id="chatMessages"></div>
            <input type="text" class="chat-input" id="chatInput" placeholder="Type a message..." onkeydown="sendMessage(event)">
            <button id="show-location-btn" onclick="showChatUserLocation()">Show location</button>
        </div>
    </div>

    <!-- Filters Modal -->
    <div id="filtersModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('filtersModal')">&times;</span>
            <h2>Filters</h2>
            <div class="filter-options">
                <label><input type="checkbox" id="showBuyers" checked onchange="applyFilters()"> Show Buyers</label>
                <label><input type="checkbox" id="showSellers" checked onchange="applyFilters()"> Show Sellers</label>
                <label>Price Range per 1g: <input type="number" id="minPrice" placeholder="Min" onchange="applyFilters()"> - <input type="number" id="maxPrice" placeholder="Max" onchange="applyFilters()"></label>
            </div>
        </div>
    </div>

    <!-- Join Modal -->
    <div id="joinModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('joinModal')">&times;</span>
            <h2>Select Your Type</h2>
            <div class="join-options">
                <label>Username: <input type="text" id="username" required></label>
                <p style="font-size: small;">Please, use the same username each time.</p>
                <label><input type="radio" name="userType" value="Buyer"> Buyer</label>
                <label><input type="radio" name="userType" value="Seller"> Seller</label>
                <div id="sellerOptions" style="display:none;">
                    <label>Delivers: <input type="checkbox" id="delivers" checked></label>
                    <label>Price per 1g (optional): <input type="number" id="price" step="0.01" min="0"></label>
                </div>
                <button onclick="confirmJoin()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- End Session Modal -->
    <div id="endSessionModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('endSessionModal')">&times;</span>
            <h2>End Session</h2>
            <p>All data linked to your session will be erased from the server and the chats cannot be retrieved. Are you sure you want to proceed?</p>
            <button onclick="confirmEndSession()">Confirm</button>
        </div>
    </div>

    <div id="notification" onclick="handleNotificationClick()"></div>
    <div id="chat-buttons"></div>

    <script>
        const socket = io(); // Connect to backend

        let map, currentLocation, markers = [], selfUser = null, selfMarker = null, watchId = null, userId = null, users = [], chatHistories = {}, pendingMessages = {}, currentChatUser = null, activeChats = {}, joinData = null;
        let updateTimeout = null;
        let lastLocationUpdate = 0;
        let storedJoinData = localStorage.getItem('crystalMedJoinData') ? JSON.parse(localStorage.getItem('crystalMedJoinData')) : null;

        document.addEventListener('DOMContentLoaded', () => {
            loadChats();
        });

        function loadChats() {
            const storedChats = localStorage.getItem('crystalMedChats');
            if (storedChats) {
                chatHistories = JSON.parse(storedChats);
            }
        }

        function saveChats() {
            localStorage.setItem('crystalMedChats', JSON.stringify(chatHistories));
        }

        socket.on('connect', () => {
            console.log('Socket connected');
        });

        socket.on('userId', (id) => {
            userId = id;
            console.log('Received userId:', userId);
        });

        socket.on('joinSuccess', () => {
            console.log('Join success received');
            selfUser = joinData;
            selfUser.id = userId;
            addSelfMarker();
            map.setView([selfUser.lat, selfUser.lng], 13);
            watchId = navigator.geolocation.watchPosition(position => {
                selfUser.lat = position.coords.latitude;
                selfUser.lng = position.coords.longitude;
                addSelfMarker();
                if (Date.now() - lastLocationUpdate > 5000) {
                    socket.emit('updateLocation', { lat: selfUser.lat, lng: selfUser.lng });
                    lastLocationUpdate = Date.now();
                }
            }, err => {
                console.error('Location watch error:', err);
                alert('Location update failed: ' + err.message);
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
            document.getElementById('end-session-btn').style.display = 'block';
            document.querySelector('.join-btn').style.display = 'none';
            localStorage.setItem('crystalMedJoinData', JSON.stringify({ type: selfUser.type, delivers: selfUser.delivers, price: selfUser.price, name: selfUser.name }));
        });

        socket.on('nameTaken', () => {
            console.log('Name taken received');
            alert('Username is already taken. Please choose another.');
            openModal('joinModal');
        });

        socket.on('userUpdate', (updatedUsers) => {
            console.log('User update received', updatedUsers);
            users = updatedUsers.filter(u => u.id !== userId); // Exclude self
            if (updateTimeout) clearTimeout(updateTimeout);
            updateTimeout = setTimeout(applyFilters, 300);
        });

        socket.on('chatRequest', ({ from }) => {
            const sender = users.find(u => u.id === from) || { id: from, name: `User ${from.slice(0,4)}` };
            if (!activeChats[sender.name]) {
                activeChats[sender.name] = sender;
                addChatButton(sender);
            }
            showNotification(`New chat from ${sender.name}`);
        });

        socket.on('chatMessage', ({ from, message }) => {
            const sender = users.find(u => u.id === from) || { id: from, name: `User ${from.slice(0,4)}` };
            const msgText = `${sender.name}: ${message}`;
            if (!chatHistories[sender.name]) chatHistories[sender.name] = [];
            chatHistories[sender.name].push(msgText);
            saveChats();
            if (!activeChats[sender.name]) {
                activeChats[sender.name] = sender;
                addChatButton(sender);
            }
            if (currentChatUser && currentChatUser.name === sender.name && document.getElementById('chatModal').style.display === 'block') {
                const msgDiv = document.createElement('div');
                msgDiv.textContent = msgText;
                document.getElementById('chatMessages').appendChild(msgDiv);
            } else {
                if (!pendingMessages[sender.name]) pendingMessages[sender.name] = [];
                pendingMessages[sender.name].push(msgText);
                showNotification(`New message from ${sender.name}`);
            }
        });

        function addChatButton(user) {
            const chatButtons = document.getElementById('chat-buttons');
            const button = document.createElement('button');
            button.className = 'chat-button';
            button.textContent = `Chat with ${user.name}`;
            button.onclick = () => {
                currentChatUser = user;
                openChat();
            };
            chatButtons.appendChild(button);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            notification.textContent = text;
            notification.style.display = 'block';
            setTimeout(() => { notification.style.display = 'none'; }, 5000); // Auto-hide after 5s
        }

        function handleNotificationClick() {
            const notification = document.getElementById('notification');
            notification.style.display = 'none';
            if (Object.keys(pendingMessages).length > 0) {
                const name = Object.keys(pendingMessages)[0];
                currentChatUser = activeChats[name];
                openChat();
            }
        }

        function showChatUserLocation() {
            if (currentChatUser && currentChatUser.lat && currentChatUser.lng) {
                map.setView([currentChatUser.lat, currentChatUser.lng], 13);
            }
        }

        // Initialize map with dark theme and zoom control at bottom left
        function initMap(lat = 37.7749, lng = -122.4194) {
            map = L.map('map', { zoomControl: false }).setView([lat, lng], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);
            L.control.zoom({ position: 'bottomleft' }).addTo(map);
            applyFilters(); // Use socket users, no mocks
            document.getElementById('loading-message').style.display = 'none'; // Hide loading message
            autoJoinIfStored();
        }

        function autoJoinIfStored() {
            if (storedJoinData && !selfUser) {
                if (confirm(`Rejoin as ${storedJoinData.name} (${storedJoinData.type})?`)) {
                    document.getElementById('username').value = storedJoinData.name;
                    document.querySelector(`input[name="userType"][value="${storedJoinData.type}"]`).checked = true;
                    if (storedJoinData.type === 'Seller') {
                        document.getElementById('delivers').checked = storedJoinData.delivers;
                        document.getElementById('price').value = storedJoinData.price || '';
                        document.getElementById('sellerOptions').style.display = 'block';
                    }
                    confirmJoin();
                }
            }
        }

        // Add markers to map for other users
        function addMarkers() {
            clearMarkers();
            const showBuyers = document.getElementById('showBuyers')?.checked ?? true;
            const showSellers = document.getElementById('showSellers')?.checked ?? true;
            const minPrice = parseFloat(document.getElementById('minPrice')?.value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice')?.value) || Infinity;

            users.forEach(user => {
                if (currentLocation && calculateDistance(currentLocation.lat, currentLocation.lng, user.lat, user.lng) > 50) return; // Local filter: 50km radius

                let marker;
                if (user.type === 'Buyer' && showBuyers && (user.price === null || (user.price >= minPrice && user.price <= maxPrice))) {
                    marker = L.circleMarker([user.lat, user.lng], {
                        radius: 10;
                        fillColor: 'orange',
                        color: 'orange',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                } else if (user.type === 'Seller' && showSellers && (user.price === null || (user.price >= minPrice && user.price <= maxPrice))) {
                    const color = user.delivers ? 'green' : 'blue';
                    const triangleHtml = `
                        <div style="
                            width: 0;
                            height: 0;
                            border-left: 12px solid transparent;
                            border-right: 12px solid transparent;
                            border-bottom: 24px solid ${color};
                            transform: translate(-50%, -50%);
                        "></div>
                    `;
                    const icon = L.divIcon({
                        html: triangleHtml,
                        className: '',
                        iconSize: [24, 24],
                        iconAnchor: [12, 24]
                    });
                    marker = L.marker([user.lat, user.lng], { icon: icon }).addTo(map);
                }
                if (marker) {
                    marker.bindPopup(`<b>${user.name}</b><br>${user.type}`);
                    marker.bindTooltip(user.name, { permanent: true, direction: 'bottom', offset: [0, 20] });
                    marker.on('click', () => showProfile(user));
                    markers.push(marker);
                }
            });
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        function applyFilters() {
            addMarkers();
            if (selfUser) addSelfMarker();
        }

        // Haversine distance formula for local filtering
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Join map functionality
        function joinMap() {
            if (selfUser) {
                alert('You are already on the map!');
                return;
            }
            openModal('joinModal');
        }

        // Confirm join
        function confirmJoin() {
            const selectedType = document.querySelector('input[name="userType"]:checked');
            if (!selectedType) {
                alert('Please select a type!');
                return;
            }
            const username = document.getElementById('username').value.trim();
            if (!username) {
                alert('Please enter a username!');
                return;
            }
            const type = selectedType.value;
            let delivers = false;
            let price = null;
            if (type === 'Seller') {
                delivers = document.getElementById('delivers').checked;
                price = parseFloat(document.getElementById('price').value) || null;
            }
            joinData = {
                type: type,
                delivers: delivers,
                price: price,
                name: username,
                img: 'https://via.placeholder.com/100?text=You'
            };
            closeModal('joinModal');
            navigator.geolocation.getCurrentPosition(position => {
                joinData.lat = position.coords.latitude;
                joinData.lng = position.coords.longitude;
                console.log('Sending join with data:', joinData);
                socket.emit('join', joinData);
            }, err => {
                console.error('Geolocation error:', err);
                alert('Unable to get location: ' + err.message + '. Please allow location access.');
            }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        }

        // Add/update self marker
        function addSelfMarker() {
            if (selfMarker) map.removeLayer(selfMarker);
            const showBuyers = document.getElementById('showBuyers')?.checked ?? true;
            const showSellers = document.getElementById('showSellers')?.checked ?? true;
            const minPrice = parseFloat(document.getElementById('minPrice')?.value) || 0;
            const maxPrice = parseFloat(document.getElementById('maxPrice')?.value) || Infinity;
            const shouldShow = (selfUser.type === 'Buyer' && showBuyers) || (selfUser.type === 'Seller' && showSellers);
            if (!shouldShow || (selfUser.price !== null && (selfUser.price < minPrice || selfUser.price > maxPrice))) {
                console.log('Self marker hidden by filters');
                return;
            }

            const color = selfUser.type === 'Buyer' ? 'yellow' : 'red';
            const starHtml = `
                <div style="
                    font-size: 24px;
                    color: ${color};
                    text-shadow: 0 0 3px black;
                    transform: translate(-50%, -50%);
                ">★</div>
            `;
            const icon = L.divIcon({
                html: starHtml,
                className: '',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            const marker = L.marker([selfUser.lat, selfUser.lng], { icon: icon });
            marker.addTo(map);
            marker.bindPopup(`<b>${selfUser.name}</b><br>${selfUser.type}`);
            marker.bindTooltip(selfUser.name, { permanent: true, direction: 'bottom', offset: [0, 20] });
            marker.on('click', () => showProfile(selfUser));
            selfMarker = marker;
            console.log('Self marker added at', selfUser.lat, selfUser.lng);
        }

        // Show profile modal
        function showProfile(user) {
            document.getElementById('profileImg').src = user.img || 'https://ineedmeth.com/wp-content/uploads/2025/07/logo.png';
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileType').textContent = user.type;
            let details = '';
            if (user.price !== null) details += `Price: $${user.price} per 1g `;
            if (user.type === 'Seller') details += `(Delivers: ${user.delivers ? 'Yes' : 'No'})`;
            document.getElementById('profileDetails').textContent = details;
            openModal('profileModal');
            currentChatUser = user;
        }

        // Chat functionality
        function openChat() {
            if (currentChatUser.id === userId) {
                alert('You cannot chat with yourself!');
                closeModal('profileModal');
                return;
            }
            closeModal('profileModal');
            document.getElementById('chatName').textContent = currentChatUser.name;
            document.getElementById('chatMessages').innerHTML = '';
            const history = chatHistories[currentChatUser.name] || [];
            history.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.textContent = msg;
                document.getElementById('chatMessages').appendChild(msgDiv);
            });
            if (pendingMessages[currentChatUser.name]) {
                pendingMessages[currentChatUser.name].forEach(msg => {
                    const msgDiv = document.createElement('div');
                    msgDiv.textContent = msg;
                    document.getElementById('chatMessages').appendChild(msgDiv);
                });
                delete pendingMessages[currentChatUser.name];
            }
            openModal('chatModal');
            socket.emit('startChat', currentChatUser.id);
        }

        function sendMessage(event) {
            if (event.key === 'Enter') {
                const input = document.getElementById('chatInput');
                const message = input.value;
                if (message) {
                    const msgText = `You: ${message}`;
                    if (!chatHistories[currentChatUser.name]) chatHistories[currentChatUser.name] = [];
                    chatHistories[currentChatUser.name].push(msgText);
                    saveChats();
                    const msgDiv = document.createElement('div');
                    msgDiv.textContent = msgText;
                    document.getElementById('chatMessages').appendChild(msgDiv);
                    input.value = '';
                    socket.emit('chatMessage', { to: currentChatUser.id, message });
                }
            }
        }

        // Modal controls
        function openModal(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function openEndSessionModal() {
            openModal('endSessionModal');
        }

        function confirmEndSession() {
            Object.values(activeChats).forEach(chatUser => {
                socket.emit('chatMessage', { to: chatUser.id, message: `${selfUser.name} has disconnected.` });
            });
            socket.emit('disconnectUser');
            socket.disconnect();
            selfUser = null;
            if (selfMarker) map.removeLayer(selfMarker);
            selfMarker = null;
            if (watchId) navigator.geolocation.clearWatch(watchId);
            document.getElementById('end-session-btn').style.display = 'none';
            document.querySelector('.join-btn').style.display = 'block';
            chatHistories = {};
            pendingMessages = {};
            activeChats = {};
            saveChats();
            document.getElementById('chat-buttons').innerHTML = '';
            localStorage.removeItem('crystalMedJoinData');
            storedJoinData = null;
            closeModal('endSessionModal');
        }

        // Get user location and init
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                currentLocation = { lat: latitude, lng: longitude };
                initMap(latitude, longitude);
            }, (err) => {
                console.error('Initial geolocation error:', err);
                alert('Unable to get initial location: ' + err.message + '. Using default location.');
                currentLocation = { lat: 37.7749, lng: -122.4194 };
                initMap();
            }, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
        } else {
            alert('Geolocation not supported by your browser.');
            currentLocation = { lat: 37.7749, lng: -122.4194 };
            initMap();
        }

        // Setup seller options visibility
        document.querySelectorAll('input[name="userType"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('sellerOptions').style.display = radio.value === 'Seller' ? 'block' : 'none';
            });
        });
    </script>
</body>
</html>
